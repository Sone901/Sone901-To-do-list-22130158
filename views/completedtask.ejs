<html>

<head>
    <title><%= title %></title>
    <link rel="stylesheet" href="/assets/css/dashboard.css">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/7692/7692809.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
</head>

<body>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Column: Projects/Categories -->
        <div class="left-panel">
            <div class="panel-title">Projects</div>
            <div class="projects-list">
                <!-- Added "All" category button -->
                <div class="project-item active" data-category="all" onclick="filterTasksByCategory('all')">
                    <i class="fas fa-th"></i>
                    <span>All Tasks</span>
                </div>
                <div class="project-item" data-category="work" onclick="filterTasksByCategory('work')">
                    <i class="fas fa-briefcase"></i>
                    <span>Work</span>
                </div>
                <div class="project-item" data-category="personal" onclick="filterTasksByCategory('personal')">
                    <i class="fas fa-user"></i>
                    <span>Personal</span>
                </div>
                <div class="project-item" data-category="shopping" onclick="filterTasksByCategory('shopping')">
                    <i class="fas fa-shopping-bag"></i>
                    <span>Shopping</span>
                </div>
                <div class="project-item" data-category="others" onclick="filterTasksByCategory('others')">
                    <i class="fas fa-ellipsis-h"></i>
                    <span>Others</span>
                </div>
            </div>
        </div>

        <!-- Middle Column: Completed Tasks -->
        <div class="middle-panel">
            <div class="panel-header">
                <div class="panel-title">COMPLETED TASKS</div>
            </div>
            
            <div class="tasks-container" id="completedTasks">
                <% for (let task of dashboard) { %>
                    <% if (task.completed) { %>
                        <!-- Fixed XSS vulnerability by using data attributes instead of inline onclick with string concatenation -->
                        <div class="task-item completed-task" 
                             data-id="<%= task._id %>"
                             data-task-title="<%= task.task %>"
                             data-task-description="<%= task.description %>"
                             data-task-date="<%= task.date %>"
                             data-task-category="<%= task.categoryChoosed %>">
                            <div class="task-checkbox">
                                <input type="checkbox" class="task-check" checked disabled>
                            </div>
                            <div class="task-content">
                                <div class="task-title completed"><%= task.task %></div>
                                <div class="task-description"><%= task.description %></div>
                                <div class="task-meta">
                                    <span class="task-date"><%= task.date %></span>
                                    <span class="task-category"><%= task.categoryChoosed %></span>
                                    <span class="task-status done">âœ“ Completed</span>
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="btn-edit" title="Edit"><i class="fas fa-edit"></i></button>
                                <a href="/delete-task/?id=<%= task._id %>" class="btn-delete" title="Delete"><i class="fas fa-trash"></i></a>
                            </div>
                        </div>
                    <% } %>
                <% } %>
            </div>
        </div>

    </div>


    <script>

        // Category Filtering
        function filterTasksByCategory(category) {
            const taskItems = document.querySelectorAll('.task-item');
            const projectItems = document.querySelectorAll('.project-item');
            
            // Update active project
            projectItems.forEach(item => {
                if (item.dataset.category === category) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // Filter tasks
            taskItems.forEach(task => {
                const taskCategoryElement = task.querySelector('.task-category');
                if (!taskCategoryElement) return;
                
                const taskCategory = taskCategoryElement.textContent.trim().toLowerCase();
                const selectedCategory = category.toLowerCase();
                
                if (selectedCategory === 'all' || taskCategory === selectedCategory) {
                    task.style.display = 'flex';
                } else {
                    task.style.display = 'none';
                }
            });
        }

        document.getElementById('completedTasks')?.addEventListener('click', function(e) {
            const editBtn = e.target.closest('.btn-edit');
            if (editBtn) {
                const taskItem = editBtn.closest('.task-item');
                if (taskItem) {
                    const taskId = taskItem.dataset.id;
                    const taskTitle = taskItem.dataset.taskTitle;
                    const taskDescription = taskItem.dataset.taskDescription;
                    const taskDate = taskItem.dataset.taskDate;
                    const taskCategory = taskItem.dataset.taskCategory;
                    
                    editTask(taskId, taskTitle, taskDescription, taskDate, taskCategory);
                }
            }
        });

        // Edit Task Modal
        function editTask(taskId, taskTitle, taskDescription, taskDate, taskCategory) {
            document.getElementById('editTaskId').value = taskId;
            document.getElementById('editTaskTitle').value = taskTitle;
            document.getElementById('editTaskDescription').value = taskDescription;
            document.getElementById('editTaskDate').value = taskDate;
            document.getElementById('editTaskCategory').value = taskCategory;
            document.getElementById('editTaskModal').style.display = 'flex';
        }

    </script>
</body>

</html>
